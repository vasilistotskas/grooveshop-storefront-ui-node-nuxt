<script lang="ts" setup>
const { t } = useI18n({ useScope: 'local' })
const route = useRoute()
const { user } = useUserSession()
const { enabled } = useAuthPreviewMode()

const pageSize = ref(4)
const page = computed(() => route.query.page)
const ordering = computed(() => route.query.ordering || '-createdAt')

const entityOrdering = ref<EntityOrdering<BlogPostOrderingField>>([
  {
    value: 'createdAt',
    label: t('ordering.created_at'),
    options: ['ascending', 'descending'],
  },
  {
    value: 'updatedAt',
    label: t('ordering.updated_at'),
    options: ['ascending', 'descending'],
  },
])

const { data: favourites, status } = useFetch<Pagination<BlogPost>>(
  `/api/user/account/${user.value?.id}/liked-blog-posts`,
  {
    key: `likedBlogPosts${user.value?.id}`,
    method: 'GET',
    headers: useRequestHeaders(),
    query: {
      page: page,
      ordering: ordering,
      pageSize: pageSize,
      expand: 'true',
    },
  },
)

const refreshFavourites = async () => {
  status.value = 'pending'
  const favourites = await $fetch<Pagination<BlogPost>>(
    `/api/user/account/${user.value?.id}/liked-blog-posts`,
    {
      method: 'GET',
      headers: useRequestHeaders(),
      query: {
        page: page.value,
        ordering: ordering.value,
        pageSize: pageSize.value,
        expand: 'true',
      },
    },
  )
  status.value = 'success'
  return favourites
}

const pagination = computed(() => {
  if (!favourites.value) return
  return usePagination<BlogPost>(favourites.value)
})

const orderingOptions = computed(() => {
  return useOrdering<BlogPostOrderingField>(entityOrdering.value)
})

watch(
  () => route.query,
  async () => {
    favourites.value = await refreshFavourites()
  },
)

definePageMeta({
  layout: 'user',
})
</script>

<template>
  <PageWrapper
    class="
      container flex flex-col gap-4 !p-0

      md:gap-8
    "
  >
    <PageTitle :text="t('title')" />
    <LazyUserAccountFavouritesNavbar v-if="enabled" />

    <div class="flex flex-row flex-wrap items-center gap-2">
      <PaginationPageNumber
        v-if="pagination"
        :count="pagination.count"
        :page="pagination.page"
        :page-size="pagination.pageSize"
      />
      <Ordering
        :ordering="String(ordering)"
        :ordering-options="orderingOptions.orderingOptionsArray.value"
      />
    </div>
    <LazyBlogPostFavouritesList
      v-if="status !== 'pending' && favourites?.results?.length"
      :favourites="favourites?.results"
      :favourites-count="favourites?.count"
    />
    <template v-if="status === 'pending'">
      <div class="grid w-full items-start gap-4">
        <ClientOnlyFallback
          class="flex w-full items-center justify-center"
          height="20px"
          width="100%"
        />
        <ClientOnlyFallback
          class="
              grid grid-cols-2 gap-4

              lg:grid-cols-3

              xl:grid-cols-4
            "
          :count="favourites?.results?.length || 4"
          height="295px"
          width="100%"
        />
      </div>
    </template>
  </PageWrapper>
</template>

<i18n lang="yaml">
el:
  title: Αγαπημένες Δημοσιεύσεις
</i18n>
