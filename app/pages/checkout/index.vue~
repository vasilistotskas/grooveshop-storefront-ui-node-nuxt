<script lang="ts" setup>
import { string, number, array, union, object, optional, nativeEnum } from 'zod'
import {Field, useForm} from 'vee-validate'
import { defaultSelectOptionChoose, floorChoicesList, locationChoicesList } from '~/constants'
import { FloorChoicesEnum, LocationChoicesEnum } from '~/types'
import { ZodDocumentTypeEnum, ZodOrderStatusEnum } from '~/types/order'
import { ZodOrderCreateItem } from '~/types/order/order-item'
import type { PayWay } from '~/types/pay-way'
import type { Pagination } from '~/types/pagination'
import type { Region } from '~/types/region'

const { user, fetch } = useUserSession()

const cartStore = useCartStore()
const { getCartItems } = storeToRefs(cartStore)
const { cleanCartState } = cartStore

const { t, locale } = useI18n({ useScope: 'local' })
const toast = useToast()
const localePath = useLocalePath()

const UTextarea = resolveComponent('UTextarea')
const USelect = resolveComponent('USelect')

const payWay = useState<PayWay | null>('selectedPayWay')
const regions = ref<Pagination<Region> | null>(null)

const { data: countries } = await useAsyncData('countries', () =>
  $fetch('/api/countries', {
    method: 'GET',
    query: {
      language: locale.value,
    },
  }),
)

const countryOptions = computed(() => {
  return countries.value?.results?.map((country) => {
    const countryName = extractTranslated(country, 'name', locale.value)
    return {
      name: countryName,
      value: country.alpha2,
    }
  }) || []
})

const shippingPrice = ref(3)
const userId = computed(() => (user.value?.id ? String(user.value.id) : null))

const ZodCheckout = object({
  user: optional(string({ required_error: t('validation.required') })),
  country: optional(string({ required_error: t('validation.required') })),
  region: optional(string({ required_error: t('validation.required') })),
  floor: optional(union([nativeEnum(FloorChoicesEnum), string({ required_error: t('validation.required') })])),
  locationType: optional(
    union([nativeEnum(LocationChoicesEnum), string({ required_error: t('validation.required') })]),
  ),
  street: string().min(3, t('validation.street.min', { min: 3 })),
  streetNumber: string().min(1, t('validation.street_number.min', { min: 1 })),
  status: optional(ZodOrderStatusEnum),
  firstName: string().min(3, t('validation.first_name.min', { min: 3 })),
  lastName: string().min(3, t('validation.last_name.min', { min: 3 })),
  email: string({ required_error: t('validation.required') }).email(t('validation.email.valid')),
  zipcode: string().min(3, t('validation.zipcode.min', { min: 3 })),
  place: string().min(3, t('validation.place.min', { min: 3 })),
  city: string({ required_error: t('validation.required') }).min(3, t('validation.city.min', { min: 3 })),
  phone: string().min(3, t('validation.phone.min', { min: 3 })),
  mobilePhone: optional(string({ required_error: t('validation.required') })),
  customerNotes: optional(string({ required_error: t('validation.required') })),
  shippingPrice: number(),
  documentType: ZodDocumentTypeEnum,
  items: array(ZodOrderCreateItem),
  payWay: number({ required_error: t('validation.required') }),
})

const validationSchema = toTypedSchema(ZodCheckout)
const { defineField, setFieldValue, handleSubmit, errors, isSubmitting }
  = useForm({
    validationSchema,
    initialValues: {
      user: userId.value || undefined,
      country: defaultSelectOptionChoose,
      region: defaultSelectOptionChoose,
      floor: defaultSelectOptionChoose,
      locationType: defaultSelectOptionChoose,
      items:
      getCartItems.value?.map(item => ({
        ...item,
        product: item.product.id,
      })) || [],
      shippingPrice: shippingPrice.value,
      documentType: ZodDocumentTypeEnum.enum.RECEIPT,
      payWay: payWay.value?.id || undefined,
    },
  })

const [email, emailProps] = defineField('email', {
  validateOnModelUpdate: true,
})
const [firstName, firstNameProps] = defineField('firstName', {
  validateOnModelUpdate: true,
})
const [lastName, lastNameProps] = defineField('lastName', {
  validateOnModelUpdate: true,
})
const [street, streetProps] = defineField('street', {
  validateOnModelUpdate: true,
})
const [streetNumber, streetNumberProps] = defineField('streetNumber', {
  validateOnModelUpdate: true,
})
const [zipcode, zipcodeProps] = defineField('zipcode', {
  validateOnModelUpdate: true,
})
const [place, placeProps] = defineField('place', {
  validateOnModelUpdate: true,
})
const [city, cityProps] = defineField('city', {
  validateOnModelUpdate: true,
})
const [phone, phoneProps] = defineField('phone', {
  validateOnModelUpdate: true,
})
const [mobilePhone, mobilePhoneProps] = defineField('mobilePhone', {
  validateOnModelUpdate: true,
})
const [customerNotes, customerNotesProps] = defineField('customerNotes', {
  validateOnModelUpdate: true,
})
const [floor, floorProps] = defineField('floor', {
  validateOnModelUpdate: true,
})
const [locationType, locationTypeProps] = defineField('locationType', {
  validateOnModelUpdate: true,
})
const [country, countryProps] = defineField('country', {
  validateOnModelUpdate: true,
})
const [region, regionProps] = defineField('region', {
  validateOnModelUpdate: true,
})

const fetchRegions = async () => {
  if (country.value === defaultSelectOptionChoose) {
    return
  }

  try {
    regions.value = await $fetch('/api/regions', {
      method: 'GET',
      query: {
        country: country.value,
        language: locale.value,
      },
    })
  }
  catch {
    toast.add({
      title: t('error.default'),
      description: t('error_occurred'),
      color: 'red',
    })
  }
}

const regionOptions = computed(() => {
  return regions.value?.results?.map((region) => {
    const regionName = extractTranslated(region, 'name', locale.value)
    return {
      name: regionName,
      value: region.alpha,
    }
  }) || []
})

const onCountryChange = async (event: Event) => {
  if (!(event.target instanceof HTMLSelectElement)) return
  country.value = event.target.value
  region.value = defaultSelectOptionChoose
  await fetchRegions()
}

const onSubmit = handleSubmit(async (values) => {
  const updatedValues = processValues(values)

  await $fetch('/api/orders', {
    method: 'POST',
    headers: useRequestHeaders(),
    body: updatedValues,
    async onResponse({ response }) {
      if (!response.ok) {
        return
      }
      toast.add({
        title: t('form.submit.success'),
        color: 'green',
      })
      cleanCartState()
      await fetch()
      await navigateTo(localePath(`/checkout/success/${response._data.uuid}`))
    },
    onResponseError({ error }) {
      toast.add({
        title: error?.message,
        color: 'red',
      })
    },
  })
})

const submitButtonDisabled = computed(() => {
  return isSubmitting.value || Object.keys(errors.value).length > 0
})

watch(
  () => payWay.value,
  () => {
    setFieldValue('payWay', payWay.value?.id || undefined)
  },
)

definePageMeta({
  layout: 'default',
})
</script>

<template>
  <PageWrapper
    class="
      container-md flex flex-col gap-4

      md:gap-8
    "
  >
    <PageBody>
      <form
        id="checkoutForm"
        class="
          _form grid gap-2

          lg:grid-cols-[2fr,0.75fr]

          md:gap-4
        "
        name="checkoutForm"
        @submit="onSubmit"
      >
        <div
          class="
            bg-primary-100 container grid gap-4 rounded-lg !p-6 text-primary-50

            dark:bg-primary-900 dark:text-primary-950

            md:p-10
          "
        >
          <div
            class="
              flex flex-col gap-4

              md:grid md:grid-cols-2
            "
          >
            <div class="grid">
              <label
                class="
                  text-primary-950 sr-only mb-2

                  dark:text-primary-50
                "
                for="firstName"
              >{{ t('form.first_name') }}</label>
              <div class="grid">
                <FormTextInput
                  id="firstName"
                  v-model="firstName"
                  :bind="firstNameProps"
                  :placeholder="t('form.first_name')"
                  autocomplete="given-name"
                  name="firstName"
                  type="text"
                />
              </div>
              <span
                v-if="errors.firstName"
                class="text-xs text-red-600"
              >{{
                errors.firstName
              }}</span>
            </div>

            <div class="grid">
              <label
                class="
                  text-primary-950 sr-only mb-2

                  dark:text-primary-50
                "
                for="lastName"
              >{{ t('form.last_name') }}</label>
              <div class="grid">
                <FormTextInput
                  id="lastName"
                  v-model="lastName"
                  :bind="lastNameProps"
                  :placeholder="t('form.last_name')"
                  autocomplete="family-name"
                  name="lastName"
                  type="text"
                />
              </div>
              <span
                v-if="errors.lastName"
                class="text-xs text-red-600"
              >{{
                errors.lastName
              }}</span>
            </div>

            <div class="grid">
              <label
                class="
                  text-primary-950 sr-only mb-2

                  dark:text-primary-50
                "
                for="email"
              >{{ t('form.email') }}</label>
              <div class="grid">
                <FormTextInput
                  id="email"
                  v-model="email"
                  :bind="emailProps"
                  :placeholder="t('form.email')"
                  autocomplete="email"
                  name="email"
                  type="email"
                />
              </div>
              <span
                v-if="errors.email"
                class="text-xs text-red-600"
              >{{
                errors.email
              }}</span>
            </div>

            <div class="grid">
              <label
                class="
                  text-primary-950 sr-only mb-2

                  dark:text-primary-50
                "
                for="phone"
              >{{ t('form.phone') }}</label>
              <div class="grid">
                <FormTextInput
                  id="phone"
                  v-model="phone"
                  :bind="phoneProps"
                  :placeholder="t('form.phone')"
                  autocomplete="tel"
                  name="phone"
                  type="text"
                />
              </div>
              <span
                v-if="errors.phone"
                class="text-xs text-red-600"
              >{{
                errors.phone
              }}</span>
            </div>

            <div class="grid">
              <label
                class="
                  text-primary-950 sr-only mb-2

                  dark:text-primary-50
                "
                for="mobilePhone"
              >{{ t('form.mobile_phone') }}</label>
              <div class="grid">
                <FormTextInput
                  id="mobilePhone"
                  v-model="mobilePhone"
                  :bind="mobilePhoneProps"
                  :placeholder="t('form.mobile_phone')"
                  autocomplete="tel"
                  name="mobilePhone"
                  type="text"
                />
              </div>
              <span
                v-if="errors.mobilePhone"
                class="text-xs text-red-600"
              >{{
                errors.mobilePhone
              }}</span>
            </div>

            <div class="grid">
              <label
                class="
                  text-primary-950 sr-only mb-2

                  dark:text-primary-50
                "
                for="city"
              >{{ t('form.city') }}</label>
              <div class="grid">
                <FormTextInput
                  id="city"
                  v-model="city"
                  :bind="cityProps"
                  :placeholder="t('form.city')"
                  autocomplete="address-level2"
                  name="city"
                  type="text"
                />
              </div>
              <span
                v-if="errors.city"
                class="text-xs text-red-600"
              >{{
                errors.city
              }}</span>
            </div>

            <div class="grid">
              <label
                class="
                  text-primary-950 sr-only mb-2

                  dark:text-primary-50
                "
                for="place"
              >{{ t('form.place') }}</label>
              <div class="grid">
                <FormTextInput
                  id="place"
                  v-model="place"
                  :bind="placeProps"
                  :placeholder="t('form.place')"
                  autocomplete="address-level2"
                  name="place"
                  type="text"
                />
              </div>
              <span
                v-if="errors.place"
                class="text-xs text-red-600"
              >{{
                errors.place
              }}</span>
            </div>

            <div class="grid content-evenly items-start gap-1">
              <label
                class="
                  text-primary-950 sr-only mb-2

                  dark:text-primary-50
                "
                for="zipcode"
              >{{ t('form.zipcode') }}</label>
              <div class="grid">
                <FormTextInput
                  id="zipcode"
                  v-model="zipcode"
                  :bind="zipcodeProps"
                  :placeholder="t('form.zipcode')"
                  autocomplete="postal-code"
                  name="zipcode"
                  type="text"
                />
              </div>
              <span
                v-if="errors.zipcode"
                class="text-xs text-red-600"
              >{{
                errors.zipcode
              }}</span>
            </div>

            <div class="grid">
              <label
                class="
                  text-primary-950 sr-only mb-2

                  dark:text-primary-50
                "
                for="street"
              >{{ t('form.street') }}</label>
              <div class="grid">
                <FormTextInput
                  id="street"
                  v-model="street"
                  :bind="streetProps"
                  :placeholder="t('form.street')"
                  autocomplete="address-line1"
                  name="street"
                  type="text"
                />
              </div>
              <span
                v-if="errors.street"
                class="text-xs text-red-600"
              >{{
                errors.street
              }}</span>
            </div>

            <div class="grid">
              <label
                class="
                  text-primary-950 sr-only mb-2

                  dark:text-primary-50
                "
                for="streetNumber"
              >{{ t('form.street_number') }}</label>
              <div class="grid">
                <FormTextInput
                  id="streetNumber"
                  v-model="streetNumber"
                  :bind="streetNumberProps"
                  :placeholder="t('form.street_number')"
                  autocomplete="address-line2"
                  name="streetNumber"
                  type="text"
                />
              </div>
              <span
                v-if="errors.streetNumber"
                class="text-xs text-red-600"
              >{{
                errors.streetNumber
              }}</span>
            </div>

            <div class="col-span-2 grid">
              <label
                class="
                  text-primary-950 sr-only mb-2

                  dark:text-primary-50
                "
                for="customerNotes"
              >{{ t('form.customer_notes') }}</label>
              <div class="grid">
                <Field
                  id="customerNotes"
                  v-model="customerNotes"
                  :as="UTextarea"
                  :placeholder="t('form.customer_notes')"
                  :rows="4"
                  color="primary"
                  name="customerNotes"
                  type="text"
                  v-bind="customerNotesProps"
                />
              </div>
            </div>
          </div>
          <div
            class="
              grid gap-4

              md:grid-cols-2
            "
          >
            <div class="grid content-evenly items-start gap-2">
              <div class="grid">
                <label
                  class="
                    text-primary-950 mb-2

                    dark:text-primary-50
                  "
                  for="floor"
                >{{ t('form.floor') }}</label>
                <Field
                  id="floor"
                  v-model="floor"
                  :as="USelect"
                  :bind="floorProps"
                  :options="floorChoicesList"
                  :placeholder="floor === defaultSelectOptionChoose ? `${defaultSelectOptionChoose}...` : ''"
                  color="white"
                  name="floor"
                  option-attribute="name"
                />
                <span
                  v-if="errors.floor"
                  class="text-xs text-red-600"
                >{{
                  errors.floor
                }}</span>
              </div>
              <div class="grid">
                <label
                  class="
                    text-primary-950 mb-2

                    dark:text-primary-50
                  "
                  for="locationType"
                >{{ t('form.location_type') }}</label>
                <Field
                  id="locationType"
                  v-model="locationType"
                  :as="USelect"
                  :options="locationChoicesList"
                  :placeholder="locationType === defaultSelectOptionChoose ? `${defaultSelectOptionChoose}...` : ''"
                  color="white"
                  name="locationType"
                  option-attribute="name"
                  v-bind="locationTypeProps"
                />
                <span
                  v-if="errors.locationType"
                  class="text-xs text-red-600"
                >{{
                  errors.locationType
                }}</span>
              </div>
            </div>

            <div class="grid content-evenly items-start gap-2">
              <div class="grid">
                <label
                  class="
                    text-primary-950 mb-2

                    dark:text-primary-50
                  "
                  for="country"
                >{{ t('form.country') }}</label>
                <div class="grid">
                  <Field
                    id="country"
                    v-model="country"
                    :as="USelect"
                    :options="countryOptions"
                    :placeholder="country === defaultSelectOptionChoose ? `${defaultSelectOptionChoose}...` : ''"
                    color="white"
                    name="country"
                    option-attribute="name"
                    v-bind="countryProps"
                    @change.capture="onCountryChange"
                  />
                </div>
                <span
                  v-if="errors.country"
                  class="text-xs text-red-600"
                >{{
                  errors.country
                }}</span>
              </div>
              <div class="grid">
                <label
                  class="
                    text-primary-950 mb-2

                    dark:text-primary-50
                  "
                  for="region"
                >{{ t('form.region') }}</label>
                <div class="grid">
                  <Field
                    id="region"
                    v-model="region"
                    :as="USelect"
                    :options="regionOptions"
                    :placeholder="region === defaultSelectOptionChoose ? `${defaultSelectOptionChoose}...` : ''"
                    color="white"
                    name="region"
                    option-attribute="name"
                    v-bind="regionProps"
                  />
                </div>
                <span
                  v-if="errors.region"
                  class="text-xs text-red-600"
                >{{
                  errors.region
                }}</span>
              </div>
            </div>
          </div>
        </div>
        <CheckoutSidebar
          :shipping-price="shippingPrice"
          class="
            bg-primary-100 container rounded-lg !p-6 text-primary-50

            dark:bg-primary-900 dark:text-primary-950

            md:p-8
          "
        >
          <template #pay-ways>
            <CheckoutPayWays>
              <template #error>
                <span
                  v-if="errors.payWay"
                  class="text-center text-xs text-red-600"
                >{{ errors.payWay }}</span>
              </template>
            </CheckoutPayWays>
          </template>
          <template #items>
            <CheckoutItems />
          </template>
          <template #button>
            <div class="grid items-center">
              <button
                :aria-busy="isSubmitting"
                :disabled="submitButtonDisabled"
                class="
                  rounded bg-secondary px-4 py-2 font-bold text-primary-50

                  dark:bg-secondary-dark

                  disabled:cursor-not-allowed disabled:opacity-50
                "
                type="submit"
              >
                {{ t('form.submit.title') }}
              </button>
            </div>
          </template>
        </CheckoutSidebar>
      </form>
    </PageBody>
  </PageWrapper>
</template>

<i18n lang="yaml">
el:
  title: Ολοκλήρωση αγοράς
  form:
    first_name: Ονομα
    last_name: Επίθετο
    email: Email
    phone: Τηλέφωνο
    place: Περιοχή
    zipcode: Ταχυδρομικός Κώδικας
    country: Χώρα
    region: Περιφέρεια
    mobile_phone: Κινητό τηλέφωνο
    floor: Πάτωμα
    location_type: Τύπος τοποθεσίας
    street: Δρόμος
    street_number: Αριθμός δρόμου
    customer_notes: Σημειώσεις Πελατών
    submit:
      title: Αποθήκευση
      success: Η παραγγελία δημιουργήθηκε με επιτυχία
      error: Σφάλμα δημιουργίας παραγγελίας
  validation:
    email:
      required: Απαιτείται email
      email: Το email πρέπει να είναι έγκυρο
    first_name:
      min: Το όνομα πρέπει να έχει τουλάχιστον %{min} χαρακτήρες
    last_name:
      min: Το επώνυμο πρέπει να έχει τουλάχιστον %{min} χαρακτήρες
    street:
      min: Η οδός πρέπει να έχει τουλάχιστον %{min} χαρακτήρες
    street_number:
      min: Ο αριθμός οδού πρέπει να έχει τουλάχιστον %{min} χαρακτήρες
    zipcode:
      min: Ο ταχυδρομικός κώδικας πρέπει να έχει μήκος τουλάχιστον %{min} χαρακτήρων
    place:
      min: Το μέρος πρέπει να έχει τουλάχιστον %{min} χαρακτήρες
    city:
      min: Η πόλη πρέπει να έχει τουλάχιστον %{min} χαρακτήρες
    phone:
      min: Το τηλέφωνο πρέπει να έχει τουλάχιστον %{min} χαρακτήρες
</i18n>
